<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Park Faaliyet</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
<style>
*{box-sizing:border-box;font-family:Arial, sans-serif}
body{margin:0;overflow:hidden;background:#000;color:#fff}
video.bg{position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-2;opacity:.4}
#screensaver{position:fixed;top:0;left:0;width:100%;height:100%;background:black;z-index:10;display:none}
#screensaver video{width:100%;height:100%;object-fit:cover}
header{padding:10px;text-align:center;font-size:22px;font-weight:bold}
nav{display:flex;justify-content:space-around;background:#111;padding:10px}
nav button{padding:10px 15px;font-size:16px}
section{display:none;padding:10px;height:calc(100vh - 120px);overflow:auto}
section.active{display:block}
label{font-size:14px;opacity:.8}
input,textarea,button{width:100%;margin:6px 0;padding:10px;font-size:16px}
textarea{height:200px}
.card{display:flex;background:#222;margin:8px 0;border-radius:10px;overflow:hidden;cursor:pointer;}
.card img{width:120px;height:120px;object-fit:cover;margin-right:4px;}
.card div{padding:10px;flex:1;position:relative}
.iconbar{display:flex;gap:15px;margin-top:10px;font-size:20px;justify-content:flex-end;position:absolute;top:10px;right:10px;}
.iconbar span{cursor:pointer}
.trashItem{display:flex;justify-content:space-between;align-items:center;background:#222;margin:6px 0;padding:8px;border-radius:8px;}
.trashIcons span{font-size:20px;margin-left:10px;cursor:pointer}
#detail{padding:10px;background:#fff;color:#000;}
#detail img{width:48%;margin-top:25px;margin-right:1%;}
#detail .text{padding:5px;font-size:18px;margin-top:5px;}
#searchBox{margin:3px 0;padding:8px;width:100%;font-size:16px;border-radius:6px;border:1px solid #ccc}
body.add-bg{background:url('pexels-eberhardgross-1301976.jpg') no-repeat center center fixed;background-size:cover;}
body.home-bg{background:url('pexels-eberhardgross-1612351.jpg') no-repeat center center fixed;background-size:cover;}
body.settings-bg{background:url('pexels-skylar-kang-6044198.jpg') no-repeat center center fixed;background-size:cover;}
</style>
</head>
<body class="home-bg">

<video class="bg" autoplay muted loop id="mainVideo" style="display:none;">
<source src="acilis.mp4" type="video/mp4">
</video>

<div id="screensaver">
<video autoplay muted loop>
<source src="acilis.mp4" type="video/mp4">
</video>
</div>

<header>PARK FAALƒ∞YET</header>

<nav>
<button onclick="show('home')">Ana</button>
<button onclick="show('add')">Yeni</button>
<button onclick="show('settings')">Ayarlar</button>
</nav>

<section id="home" class="active">
<input type="text" id="searchBox" placeholder="Ara..." oninput="filter(this.value)">
<div id="cardsContainer" style="overflow-y:auto;max-height:calc(100vh-150px)"></div>
</section>

<section id="add">
<h3>Yeni Kayƒ±t</h3>
<label>Tarih</label>
<input type="date" id="date">
<input type="file" id="img1" accept="image/*">
<input type="file" id="img2" accept="image/*">
<textarea id="desc" placeholder="A√ßƒ±klama"></textarea>
<button id="saveBtn">Kaydet</button>
</section>

<section id="detail"></section>

<section id="settings">
<h3>Yedek</h3>
<div id="backupInfo" style="margin-bottom:10px;">Son yedekleme: -</div>
<label>Ba≈ülangƒ±√ß Tarihi</label>
<input type="date" id="s1">
<label>Biti≈ü Tarihi</label>
<input type="date" id="s2">
<button id="exportZipBtn">ZIP Dƒ±≈üa Aktar</button>
<input type="file" id="zipInput">
<button id="importZipBtn">ZIP ƒ∞√ße Aktar</button>
<button id="exportPDFBtn">PDF Olu≈ütur</button>
<h3>√á√∂p Kutusu</h3>
<button onclick="showTrash()">√á√∂p Kutusunu A√ß</button>
<div id="trash"></div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxSO4tLfEmmKLAztLD9ZbRjgtDvm6bXZ9Y37sJH2SpNYqX_NSQOysFfvaTrYeajX4-h4g/exec";
let data = [];
let trash = [];
let lastSave=0;
let idleTimer;
let saveLock = false;
let zipLock = false;
let pdfLock = false;

function resetIdle(){
clearTimeout(idleTimer);
screensaver.style.display="none";
idleTimer=setTimeout(()=>screensaver.style.display="block",15000);
}
document.onclick=resetIdle;resetIdle();

function show(id){
document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
document.body.className=id=='home'?'home-bg':id=='add'?'add-bg':'settings-bg';
if(id=="home") fetchData();
}

function formatDate(trDate){
let d=new Date(trDate);
return d.getDate().toString().padStart(2,'0') + '.' + (d.getMonth()+1).toString().padStart(2,'0') + '.' + d.getFullYear();
}

async function fetchData(){
try{
const res = await fetch(SHEET_URL);
data = await res.json();
render();
}catch(e){console.error(e);}
}

document.getElementById('saveBtn').addEventListener('click', async function(){
if(saveLock) return;
saveLock = true;
setTimeout(()=>saveLock=false, 2000);

let dateVal = date.value;
let descVal = desc.value;

if(!dateVal){alert("Tarih se√ßiniz");saveLock=false;return;}
if(!descVal){alert("A√ßƒ±klama giriniz");saveLock=false;return;}

let r={tarih: dateVal, aciklama: descVal, imgs: []};
let files = [img1,img2];
let loaded=0;
let filesToRead = files.filter(f=>f.files[0]).length;

function pushData(){
fetch(SHEET_URL,{
method:'POST',
headers: {'Content-Type':'application/json'},
body: JSON.stringify(r)
}).then(res=>res.text()).then(txt=>{
if(txt==="DUPLICATE"){alert("Bu kayƒ±t zaten var");}
else if(txt==="OK"){alert("Kayƒ±t ba≈üarƒ±yla eklendi");}
img1.value="";img2.value="";desc.value="";date.value="";
fetchData();
}).finally(()=>{saveLock=false;});
}

if(filesToRead>0){
files.forEach(f=>{
if(f.files[0]){
let reader = new FileReader();
reader.onload = e=>{
r.imgs.push(e.target.result);
loaded++;
if(loaded===filesToRead) pushData();
};
reader.readAsDataURL(f.files[0]);
}
});
}else pushData();
});

function render(){
let container=document.getElementById("cardsContainer");
container.innerHTML="";
data.forEach((r,i)=>{
let c=document.createElement("div");
c.className="card";
c.innerHTML=`<img src="${r.imgs[0]||''}">
<div>
<b>${formatDate(r.tarih)}</b><br>${r.aciklama}
<div class="iconbar">
<span onclick="edit(${i})">‚úèÔ∏è</span>
<span onclick="delRec(${i})">üóëÔ∏è</span>
</div>
</div>`;
c.onclick=(e)=>{if(!e.target.closest('.iconbar')) openDetail(i)};
container.appendChild(c);
});
}

function filter(text){
document.querySelectorAll(".card").forEach(c=>{
c.style.display=c.innerText.toLowerCase().includes(text.toLowerCase())?"flex":"none";
});
}

function delRec(i){
if(!confirm("Silmek istediƒüine emin misin?"))return;
trash.push({...data[i],deleted:Date.now()});
data.splice(i,1);
render();
}

function showTrash(){
let html="";
trash.forEach((t,i)=>{
html+=`
<div class="trashItem">
<div>${formatDate(t.tarih)}<br>${t.aciklama}</div>
<div class="trashIcons">
<span onclick="restore(${i})">‚ôªÔ∏è</span>
<span onclick="perma(${i})">üóëÔ∏è</span>
</div>
</div>`;
});
document.getElementById("trash").innerHTML=html;
}

function restore(i){
data.push(trash[i]);
trash.splice(i,1);
showTrash();
}

function perma(i){
if(!confirm("Kalƒ±cƒ± olarak silinsin mi?"))return;
trash.splice(i,1);
showTrash();
}

function openDetail(i){
let r=data[i];
detail.innerHTML="";
detail.style.background="#fff";
document.querySelector(".bg").style.display="none";
r.imgs.forEach(img=>{
let im=document.createElement("img");
im.src=img;
im.style.marginRight="1%";
detail.appendChild(im);
});
let txt=document.createElement("div");
txt.className="text";
txt.style.marginTop="5px";
txt.innerHTML=`${formatDate(r.tarih)}<br>${r.aciklama}`;
detail.appendChild(txt);
let btn=document.createElement("button");
btn.innerText="Geri";
btn.onclick=()=>{
show('home');
document.querySelector(".bg").style.display="block";
};
detail.appendChild(btn);
show("detail");
}

// ZIP Export/Import
document.getElementById('exportZipBtn').onclick = async function(){
if(zipLock){alert("ZIP i≈ülemi zaten √ßalƒ±≈üƒ±yor"); return;}
zipLock=true;
setTimeout(()=>zipLock=false,60000);
let s=s1.value,e=s2.value;
let zip=new JSZip();
data.filter(r=>r.tarih>=s && r.tarih<=e).forEach((r,i)=>zip.file(`k${i}.json`,JSON.stringify(r)));
let blob=await zip.generateAsync({type:"blob"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=`${s}_${e}.zip`;
a.click();
alert("ZIP ba≈üarƒ±yla olu≈üturuldu");
};

document.getElementById('importZipBtn').onclick = async function(){
if(zipLock){alert("ZIP y√ºkleme zaten √ßalƒ±≈üƒ±yor"); return;}
zipLock=true;
setTimeout(()=>zipLock=false,60000);
let file=zipInput.files[0];
let zip=await JSZip.loadAsync(file);
for(let f in zip.files){
let txt=await zip.files[f].async("string");
data.push(JSON.parse(txt));
}
alert("ZIP ba≈üarƒ±yla y√ºklendi");
render();
};

// PDF Olu≈ütur
document.getElementById('exportPDFBtn').onclick = function(){
if(pdfLock){alert("PDF i≈ülemi zaten √ßalƒ±≈üƒ±yor"); return;}
pdfLock=true;
setTimeout(()=>pdfLock=false,60000);
const { jsPDF } = window.jspdf;
let doc = new jsPDF();
let x=10,y=10,rowHeight=50;
data.forEach((r,i)=>{
let col = i%3===0?10:i%3===1?70:130;
if(i%3===0 && i!==0) y += rowHeight;
if(r.imgs[0]) doc.addImage(r.imgs[0],'JPEG',col,y,50,30);
doc.text(formatDate(r.tarih)+" "+r.aciklama,col,y+35);
if(i%3===2) y += 5;
});
doc.save("faaliyet.pdf");
alert("PDF ba≈üarƒ±yla olu≈üturuldu");
};

function edit(i){
alert("D√ºzenleme fonksiyonu eklenecek ü•∞");
}

fetchData();
</script>
</body>
</html>
