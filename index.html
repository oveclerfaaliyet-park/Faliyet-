<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Park Faaliyet</title>
<style>
body{font-family:Arial,sans-serif;background:#111;color:#fff;padding:12px}
input,textarea,button{width:100%;padding:8px;margin:6px 0}
.card{background:#222;padding:10px;border-radius:8px;margin:8px 0}
.card img{max-width:120px;height:auto;margin-right:6px}
</style>
</head>
<body>
<h2>Park Faaliyet</h2>

<div>
  <label>Tarih</label>
  <input type="date" id="date">
  <label>Açıklama</label>
  <textarea id="desc"></textarea>
  <label>Resim 1</label>
  <input type="file" id="img1" accept="image/*">
  <label>Resim 2</label>
  <input type="file" id="img2" accept="image/*">
  <button id="saveBtn">Kaydet</button>
</div>

<hr>
<h3>Kayıtlar</h3>
<div id="cardsContainer">Yükleniyor...</div>

<script>
const DEPLOY_URL = "https://script.google.com/macros/s/AKfycbwjI8N93KUYFDQnBVAZRPXOTtJdjDAO2Z3_3ZuTcm153SQwSOY9YlqaqdUmmTAjRHMUpA/exec";

// Base64 okuyup döndürür; boşsa ""
function readFileBase64(file){
  return new Promise((resolve)=>{
    if(!file) { resolve(""); return; }
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = () => resolve("");
    r.readAsDataURL(file);
  });
}

// FormData ile gönder (preflight kaçınmak için)
async function sendFormData(tarih, aciklama, resim1Base64, resim2Base64){
  const form = new FormData();
  form.append("tarih", tarih);
  form.append("aciklama", aciklama);
  // Base64 string alanlara ekliyoruz (text)
  form.append("resim1", resim1Base64 || "");
  form.append("resim2", resim2Base64 || "");

  const resp = await fetch(DEPLOY_URL, {
    method: "POST",
    body: form
  });
  return resp.json();
}

document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const tarih = document.getElementById("date").value;
  const aciklama = document.getElementById("desc").value;
  if(!tarih || !aciklama){ alert("Tarih ve açıklama gerekli"); return; }
  const resim1File = document.getElementById("img1").files[0];
  const resim2File = document.getElementById("img2").files[0];
  const r1 = await readFileBase64(resim1File);
  const r2 = await readFileBase64(resim2File);

  try{
    const res = await sendFormData(tarih, aciklama, r1, r2);
    if(res.status === "success"){
      alert("Kaydedildi!");
      // temizle
      document.getElementById("date").value="";
      document.getElementById("desc").value="";
      document.getElementById("img1").value="";
      document.getElementById("img2").value="";
      loadData();
    } else {
      alert("Sunucu hatası: " + (res.message || "bilinmiyor"));
      console.error(res);
    }
  } catch(err){
    console.error("Gönderme hatası", err);
    alert("Gönderme hatası: konsolu kontrol et.");
  }
});

// GET ile verileri çek ve render et
async function loadData(){
  const container = document.getElementById("cardsContainer");
  container.innerHTML = "Yükleniyor...";
  try{
    const r = await fetch(DEPLOY_URL + "?action=get");
    const data = await r.json();
    if(!Array.isArray(data) || data.length===0){ container.innerHTML = "Kayıt yok"; return; }
    container.innerHTML = "";
    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "card";
      const imgs = (item.resim1? `<img src="${item.resim1}">` : "") + (item.resim2? `<img src="${item.resim2}">` : "");
      div.innerHTML = `<div><strong>${item.tarih || ""}</strong></div><div>${item.aciklama || ""}</div><div>${imgs}</div>`;
      container.appendChild(div);
    });
  }catch(err){
    console.error("Load hata", err);
    container.innerHTML = "Veri yüklenemedi (konsolu kontrol et).";
  }
}

window.addEventListener("load", loadData);
</script>
</body>
</html>
